    social_image: peertube-truenas-social.png

---

    language: en
    description: Setting up my own federated Peertube instance on my new TrueNAS home server
    published: 2021-05-21

# Installing Peertube on TrueNAS

I wanted to install Peertube on my TrueNAS host, but with a twist. The official [deployment guide](https://docs.joinpeertube.org/dependencies) assumes you want a 'docker-ish', everything-and-the-kitchen-sink install. I already had various services set up on my NAS and I didn't want to duplicate them unnecessarily.

Furthermore, I installed Peertube inside an Ubuntu VM (for reasons unrelated to this guide), but I'll try to mention some of the differences along the way if you would decide to install in a jail.

So in a nutshell below we will:

- Install [Peertube](https://joinpeertube.org/)
- On a [TrueNAS 12](https://www.truenas.com/docs/core/) host
- Inside an `lxc` container on an Ubuntu 20.04 [Virtual Machine](https://www.truenas.com/docs/core/applications/virtualmachines/basic/)
- PostgreSQL and Redis are shared and are installed separately in their own jails on the NAS
- The webserver/reverse proxy is also shared, it's an Nginx (with OpenResty extensions), runs in its own jail on the NAS


## Installing the dependencies

The [dependencies guide](https://docs.joinpeertube.org/dependencies) states these prerequisites for Ubuntu:

```
sudo apt update
sudo apt install certbot nginx ffmpeg postgresql postgresql-contrib openssl g++ make redis-server git python-dev cron wget
ffmpeg -version # Should be >= 4.1
g++ -v # Should be >= 5.x
```
- `certbot nginx` we already have on `webserver0`
- `postgresql postgresql-contrib` we already have on `pg0`
- `redis` we already have on `redis0`

The rest should be fine:
```
sudo apt install ffmpeg openssl g++ make
```

> ![](/img/freebsd-i.png) For deploying in a FreeBSD jail you'll need to start with [these packages instead](https://docs.joinpeertube.org/dependencies?id=freebsd).

We will also need nodejs (12, in particular) and yarn:

```
curl -fsSL https://deb.nodesource.com/setup_12.x | bash -
apt-get install -y nodejs

curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor | tee /usr/share/keyrings/yarnkey.gpg >/dev/null
echo "deb [signed-by=/usr/share/keyrings/yarnkey.gpg] https://dl.yarnpkg.com/debian stable main" | tee /etc/apt/sources.list.d/yarn.list
apt-get update && apt-get install yarn
```

> ![](/img/freebsd-i.png) If deploying in a FreeBSD jail, you'll need [`node12`](https://www.freshports.org/www/node12/) and [`npm`](https://www.freshports.org/www/npm/). Note that `node12` is deprecated because its expired Python dependency, you might want to check out `node14` instead.


## Installing a Peertube release

> Note: below I'll install from the [Peertube git repo](https://github.com/Chocobozzz/PeerTube). You can make your life somewhat easier if you just use a precompiled release as the guide describes.

Get the git repo, check out a release and install:

```
mkdir config storage versions
chmod 750 config/

cd versions
git clone https://github.com/Chocobozzz/PeerTube.git peertube-develop
cd peertube-develop/
git checkout release/3.1.0
cp -r ../peertube-develop ../peertube-3.1.0
```
On an Ubuntu 20.04 fresh install `yarn` will complain about *"Couldn't find the `python` binary"*. This is because, while Ubuntu ships with Python pre-installed, it's only exposed as `python3`.

This may seem like an easy fix, but apparently [it's more complicated than it looks](https://askubuntu.com/a/1272899). All in all, this should take care of it:

```
sudo apt install python-is-python3
```

Now we can install the dependencies:

```
cd ~/versions/peertube-3.1.0/

yarn install --pure-lockfile
```

Yarn will complain:

```
warning peertube@3.1.0: The engine "postgres" appears to be invalid.
warning peertube@3.1.0: The engine "redis-server" appears to be invalid.
warning peertube@3.1.0: The engine "ffmpeg" appears to be invalid.
```

The ffmpeg is uncalled for (it's installed) but postgres and redis-server are definitely (and intentionally) missing.

Note that we are also missing the `dist` folder so we need to rebuild it from scratch (unless you used a prebuilt release as the guide recommended):

```
npm run build
```


## Instance configuration:

```
cd ~/
ln -s versions/peertube-3.1.0 ./peertube-latest

cp peertube-latest/config/default.yaml config/default.yaml
cp peertube-latest/config/production.yaml.example config/production.yaml
```

That should take care of the defaults, now we need to configure them with the postgres, redis and webserver details.


## Shared NFS storage

First of all we want to use our NAS storage for all the videos and other stuff we will be generating. Second, we want our Nginx server to be able to directly access the data generated by Peertube, to be able to serve this without virtualization performance issues getting in the way.

To do this, we have a shared dataset designated for Peertube data, shared with our Nginx jail. We will use an [NFS share](https://www.truenas.com/docs/core/sharing/nfs/nfsshare/) to mount this inside the VM (we don't need a share to mount it inside the Nginx jail, though).

> ![](/img/freebsd-i.png) If you are deploying in a FreeBSD jail sharing the TrueNAS storage will be significantly easier, you can even do it from the Admin UI. In that case, you can skip to the next part.

The Ubuntu VM has a `webshare` user, member of the `www` group. We use this user to mount the `webshare` NFS share on boot:

```
addgroup --gid 80 www
sudo adduser --system --disabled-password --uid 8080 webshare --gid 80 --home /var/webshare

sudo echo "webshare:100000:65536" | sudo tee -a /etc/subuid
sudo echo "www:100000:65536" | sudo tee -a /etc/subgid

sudo -u webshare mkdir -p /var/webshare/data

echo -e "# NAS webshare\nhomelab.hq.flak.is:/mnt/default/www/webshare  /var/webshare/data  nfs  nfsvers=3,rw,noatime,noexec  0  0" | sudo tee -a /etc/fstab
mount /var/webshare/data
```

This same user and group exists on the NAS, helping us avoid permission issues.

Inside our container we have the `peertube:peertube` user running the show, we will map this to `webshare:www` outside in the VM:

```
echo -en uid "$(id -u webshare) $(lxc exec peertube -- id -u peertube)\ngid $(id -g webshare) $(lxc exec peertube -- id -g peertube)" | lxc config set peertube raw.idmap -
lxc restart peertube
```

Then we create a `peertube` directory in webshare and pass it into the container:

```
sudo -u webshare mkdir -p /var/webshare/data/peertube

# /var/www/peertube/storage was already created earlier
lxc config device add peertube storage disk source=/var/webshare/data/peertube path=/var/www/peertube/storage
```


## Sysctl network tuning:

The guide recommends tuning the TCP parameters to better handle Peertube traffic. I didn't fiddle with these for FreeBSD jail installs, but here's the config steps for the Ubuntu VM (remember, you will need to do this outside of the container!):

Create `/etc/sysctl.d/30-peertube-tcp.conf`:

```
net.core.default_qdisc = fq_codel
net.ipv4.tcp_congestion_control = bbr
```

Load the new configuration:

```
sudo sysctl -p /etc/sysctl.d/30-peertube-tcp.conf
```


## Starting Peertube on boot

We need two things for this:

1. Start the Peertube server on the start of the container (that is, within lxc)
2. Start the lxc container automatically on the VM boot (this is outside)

To configure automatically starting the Peertube server we create a simple `systemd` service inside the container:

In `/etc/systemd/system/peertube.service`:

```
[Unit]
Description=PeerTube daemon
After=network.target

[Service]
Type=simple
Environment=NODE_ENV=production
Environment=NODE_CONFIG_DIR=/var/www/peertube/config
User=peertube
Group=peertube
ExecStart=/usr/bin/npm start
WorkingDirectory=/var/www/peertube/peertube-latest
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=peertube
Restart=always

; Some security directives.
; Mount /usr, /boot, and /etc as read-only for processes invoked by this service.
ProtectSystem=full
; Sets up a new /dev mount for the process and only adds API pseudo devices
; like /dev/null, /dev/zero or /dev/random but not physical devices. Disabled
; by default because it may not work on devices like the Raspberry Pi.
PrivateDevices=false
; Ensures that the service process and all its children can never gain new
; privileges through execve().
NoNewPrivileges=true
; This makes /home, /root, and /run/user inaccessible and empty for processes invoked
; by this unit. Make sure that you do not depend on data inside these folders.
ProtectHome=true
; Drops the sys admin capability from the daemon.
CapabilityBoundingSet=~CAP_SYS_ADMIN

[Install]
WantedBy=multi-user.target
```

Enable & run:

```
sudo systemctl daemon-reload
sudo systemctl enable peertube
sudo systemctl start peertube
```

Enabling autostart for the LXC container is significantly less involved:

```
lxc config set peertube boot.autostart true
```


## Configuring the Nginx reverse proxy

**Remember, in my configuration we are now back in FreeBSD-land, as Nginx runs on the TrueNAS system in a jail!**

Set up Nginx using the provided template config, change the `server_name`, the `upstream backend  server`, and the SSL configuration.

Mount the peertube directory in the webserver for ease of access under `/var/www/peertube`.

If Nginx complain that `aio threads` is unsupported:
```
nginx: [emerg] "aio threads" is unsupported on this platform in /usr/local/etc/nginx/users/pityu.flaki.hu.conf:218
```

â€¦you will need to [build nginx](https://openresty.org/en/installation.html) with aio + threads support.

> Note: I'm using the OpenResty build of Nginx because I use the Lua features from that distro.

```
./configure --with-http_v2_module --with-http_postgres_module --with-ipv6 --with-file-aio --with-threads
gmake
gmake install
```

If [aio is already enabled in the kernel](https://serverfault.com/a/476766) that's all you need and the config check should confirm that you are good to go:

```
# /usr/local/openresty/nginx/sbin/nginx -t -c /usr/local/etc/nginx/nginx.conf
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful
```

Restart the server to get the newly mounted folder show up and the rebuilt nginx binary to take over.

You can use curl to confirm the Nginx & SSL setup worked:

```
curl https://pityu.flaki.hu/login --resolve pityu.flaki.hu:443:127.0.0.1
```

*(if not using Curl from inside the webserver jail don't forget to change the IP address)*


## And that was it!

Welcome to the Fediverse!

![https://files.todoist.com/user_upload/v2/2180121231/file.png](/img/peertube-installed.png)
